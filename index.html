<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>Hypha Aspect Setup Spike 1</title>
  <link rel='stylesheet' href='style.css'>
  <script src='session25519.js'></script>
</head>
<body>
  <h1>Hypha Aspect Setup Spike 1</h1>

  <form id='passwordForm'>
    <fieldset>
      <label for='domain'>Domain</label>
      <input type='text' id='domain' value='ar.al'>
    </fieldset>
    <fieldset>
      <label>Choose a strong password (min 6 words):</label>
      <input type='text' id='password'>
      <button id='submit' type='submit'>Submit</button>
    </fieldset>
  </form>

  <form id='outputForm'>
      <label for='publicSigningKey'>Public signing key:</label>
      <input type='text' id='publicSigningKey'>

      <label for='privateSigningKey'>Private signing key:</label>
      <textarea id='privateSigningKey'></textarea>

      <label for='publicEncryptionKey'>Public encryption key:</label>
      <input type='text' id='publicEncryptionKey'>

      <label for='privateEncryptionKey'>Private encryption key:</label>
      <input type='text' id='privateEncryptionKey'>
  </form>

  <script>

    // From libsodium.
    function to_hex(input) {
      // Disable input checking for this simple spike.
      // input = _any_to_Uint8Array(null, input, "input");
      var str = "",
        b,
        c,
        x;
      for (var i = 0; i < input.length; i++) {
        c = input[i] & 0xf;
        b = input[i] >>> 4;
        x =
          ((87 + c + (((c - 10) >> 8) & ~38)) << 8) |
          (87 + b + (((b - 10) >> 8) & ~38));
        str += String.fromCharCode(x & 0xff) + String.fromCharCode(x >>> 8);
      }
      return str;
    }

    // Main
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('password').focus()

      document.getElementById('passwordForm').addEventListener('submit', (event) => {
        const form = event.target
        const password = form.elements.password.value
        const domain = form.elements.domain.value

        const publicSigningKeyTextField = document.getElementById('publicSigningKey')
        const privateSigningKeyTextArea = document.getElementById('privateSigningKey')
        const publicEncryptionKeyTextField = document.getElementById('publicEncryptionKey')
        const privateEncryptionKeyTextField = document.getElementById('privateEncryptionKey')

        session25519(domain, password, (error, keys) => {
          if (error) { alert(error); return }

          publicSigningKeyTextField.value = to_hex(keys.publicSignKey)
          privateSigningKeyTextArea.value = to_hex(keys.secretSignKey)
          publicEncryptionKeyTextField.value = to_hex(keys.publicKey)
          privateEncryptionKeyTextField.value = to_hex(keys.secretKey)
        })

        event.preventDefault()
      })
    })
  </script>
</body>
</html>
